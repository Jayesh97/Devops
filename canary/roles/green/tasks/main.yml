---

- name: Recursively remove directory
  file:
    path: /home/vagrant/checkbox.io-micro-preview/
    state: absent

- git:
    repo: 'https://github.com/chrisparnin/checkbox.io-micro-preview.git'
    dest: /home/vagrant/checkbox.io-micro-preview/
    version: "{{GREEN_BRANCH}}"

- name: push only when branch is broken
  become: yes
  template:
    src: index.js.j2
    dest: /home/vagrant/checkbox.io-micro-preview/index.js
    mode: 0664
    owner: vagrant
    force: yes
  when: GREEN_BRANCH=="broken"

- name: Install node-modules
  become: yes
  npm:
    path: /home/vagrant/checkbox.io-micro-preview/

- name: Stop all services
  command: forever stopall

- name: Start the server
  shell:
    cmd: forever start index.js
  args: 
    chdir: /home/vagrant/checkbox.io-micro-preview/